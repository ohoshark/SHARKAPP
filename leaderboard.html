<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리더보드 분석 - 스내퍼 분석</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <style>
	@media (max-width: 767.98px) {
		.container.mt-4 {
			padding-bottom: 100px !important; /* FAB 버튼 높이(60px)보다 넉넉하게 줌 */
		}
	}
	.noUi-handle.red-indicator {
		border-color: #FF0000; 
		box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.4); 
	}
	.fab-custom-size {
		width: 50px; 
		height: 50px;
		padding: 0 !important; 
		display: flex; 
		align-items: center;
		justify-content: center;
		cursor: pointer;
	}
	.fab-custom-size i {
		font-size: 1.5rem; 
		color: white; 
	}
	.btn-info.rounded-circle i {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
		height: 100%;
		font-size: 1.5rem; 
		color: white; 
	}
	.btn-info.rounded-circle { 
		background-color: gray !important; 
		border-color: gray !important;     
}
	
    
    
    .dropdown-menu-end {
        
        left: auto !important;
        right: 0;
    }
    
    
    .fixed-bottom {
        padding-right: 20px !important;
    }
	@media (max-width: 767.98px) {
		
		.table-responsive .table,
		.table-responsive thead,
		.table-responsive tbody,
		.table-responsive th,
		.table-responsive td,
		.table-responsive tr {
			display: block;
		}

		
		.table-responsive thead tr {
			position: absolute;
			top: -9999px;
			left: -9999px;
		}

		
		.table-responsive tbody tr {
			border: 1px solid #ccc;
			margin-bottom: 15px;
			padding: 10px;
		}

		
		.table-responsive td {
			border: none;
			border-bottom: 1px solid #eee;
			position: relative;
			padding-left: 50% !important; 
			text-align: right;
		}

		
		.table-responsive td:before {
			
			position: absolute;
			left: 6px;
			width: 45%;
			padding-right: 10px;
			white-space: nowrap;
			text-align: left;
			font-weight: bold;
		}
		
		
		.table-responsive td:nth-of-type(1):before { content: "사용자"; }
		.table-responsive td:nth-of-type(2):before { content: "이전 순위"; }
		.table-responsive td:nth-of-type(3):before { content: "현재 순위"; }
		.table-responsive td:nth-of-type(4):before { content: "순위 변화"; }
		.table-responsive td:nth-of-type(5):before { content: "이전 {{_col_metric}}마쉐"; }
		.table-responsive td:nth-of-type(6):before { content: "현재 {{_col_metric}}마쉐"; } 
		.table-responsive td:nth-of-type(7):before { content: "{{_col_metric}}마쉐 변화"; } 
		
		
		.table-responsive td:nth-of-type(1) {
        
        text-align: left; 
        
        padding-left: 5px !important; 
		}
		
		
		
		.table-responsive td:nth-of-type(1):before { 
			display: none; 
		}
		
	}
		.d-flex.justify-content-end.mt-5 {
				
				position: relative; 
				
				z-index: 100; 
			}
        .timestamp-selector {
            margin-bottom: 20px;
        }
        .comparison-table {
            margin-top: 30px;
        }
        .text-success {
            color: #28a745 !important;
            font-weight: bold;
        }
        .text-danger {
            color: #dc3545 !important;
            font-weight: bold;
        }
		.user-link {
			
			text-decoration: none; 
			
			color: inherit; 
			
			 
		}
		.timestamp-selector {
            margin-bottom: 20px;
        }
		
		.user-link:hover {
			text-decoration: none;
			color: inherit; 
		}
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        
        <div class="d-flex align-items-center">
            
        <a class="navbar-brand" href="/{{current_project}}/">쿠키 스내퍼 분석</a>
        </div>
		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav"> <li class="nav-item">
                <li class="nav-item">
                    <a class="nav-link" href="/{{current_project}}/">사용자 분석</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/{{current_project}}/compare">사용자 비교</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/{{current_project}}/leaderboard">리더보드 분석</a>
                </li>
            </ul>
        </div>
		            <div class="dropdown me-3"> 
                <button class="btn btn-dark dropdown-toggle" type="button" id="projectDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    {{ current_project.upper() }}
                </button>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="projectDropdown">
                    <li><a class="dropdown-item" href="/vooi/{{current_page}}">VOOI</a></li>
                    <li><a class="dropdown-item" href="/spaace/{{current_page}}">SPAACE</a></li>
                    <li><a class="dropdown-item" href="/superform/{{current_page}}">SUPERFORM</a></li>
                    <li><a class="dropdown-item" href="/rayls/{{current_page}}">RAYLS</a></li>
                </ul>
            </div>
    </div>
</nav>

    <div class="container mt-4">
        <h1 class="mb-4">{{project.upper()}} 리더보드 변화 분석</h1>
        
        <div class="card timestamp-selector">
            <div class="card-header">
                <h3>비교할 시간대 선택</h3>
            </div>
				<div class="card-body">
					<form method="get" action="/{{project}}/leaderboard" id="comparisonForm">
						<div class="row mb-3">
							<div class="col-md-4">
								<label for="timeframe" class="form-label">데이터 기준:</label>
								<select class="form-select" id="timeframe" name="timeframe" onchange="this.form.submit()">
									% for tf in timeframes:
										<option value="{{ tf }}" {{ 'selected' if tf == timeframe else '' }}>{{ tf }}</option>
									% end
								</select>
							</div>
							
							<div class="col-md-4">
								<label for="metric" class="form-label">지표 기준:</label>
								<select class="form-select" id="metric" name="metric" onchange="this.form.submit()">
									<option value="snapsPercent" {{ 'selected' if metric == 'snapsPercent' else '' }}>Mindshare</option>
									<option value="cSnapsPercent" {{ 'selected' if metric == 'cSnapsPercent' else '' }}>cMindshare</option>
								</select>
							</div>
						</div>
					<div class="row mb-4">
						<div class="col-12">
							<div class="d-flex justify-content-between mb-3">
								<div class="text-start">
									<strong>이전 시점:</strong> 
									<span id="slider-timestamp1" class="text-muted"></span>
								</div>
								<div class="text-end">
									<strong>현재 시점:</strong> 
									<span id="slider-timestamp2" class="text-muted"></span>
								</div>
							</div>
							
							<div id="timeSlider" style="margin: 0 10px;"></div>
							
							<input type="hidden" id="timestamp1" name="timestamp1" value="{{ timestamp1 }}">
							<input type="hidden" id="timestamp2" name="timestamp2" value="{{ timestamp2 }}">
						</div>
					</div>
					
					</form>
				<div class="d-flex justify-content-end mt-5">
				    <form action="../{{project}}/leaderboard" method="get">
					<input type="hidden" name="timeframe" value="{{timeframe}}">
					<input type="hidden" name="metric" value="{{metric}}">
						<button type="submit" class="btn btn-primary me-3" >최근 9시간</button></form>
					<button type="submit" class="btn btn-primary" form="comparisonForm">비교하기</button>
				</div>
			</div>
		</div>
        
        <div class="card comparison-table">
            <div class="card-header">
                <h3>
                    분석 결과 
                    <small class="text-muted">
                        ({{ formatted_timestamps.get(timestamp1, timestamp1) }} → {{ formatted_timestamps.get(timestamp2, timestamp2) }})
                    </small>
                </h3>
            </div>
			<div class="card-body">
				<div class="table-responsive">
					{{ !table_html }} </div>
			</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
		const rawTimestamps = [
			% for ts in timestamps:
				"{{ ts }}",
			% end
		];

		const formattedTimestamps = {
			% for ts_key, ts_value in formatted_timestamps.items():
				"{{ ts_key }}": "{{ ts_value }}",
			% end
		};

		const currentTs1 = "{{ timestamp1 }}";
		const currentTs2 = "{{ timestamp2 }}";

		const timestampMap = {};
		rawTimestamps.forEach((ts, index) => {
			timestampMap[ts] = index;
		});


		document.addEventListener('DOMContentLoaded', function() {
			const slider = document.getElementById('timeSlider');
			const input1 = document.getElementById('timestamp1');
			const input2 = document.getElementById('timestamp2');
			const display1 = document.getElementById('slider-timestamp1');
			const display2 = document.getElementById('slider-timestamp2');

			if (rawTimestamps.length >= 2) {
				const min_index = 0;
				const max_index = rawTimestamps.length - 1;
				let start1_index = timestampMap[currentTs1];
				let start2_index = timestampMap[currentTs2];

				const start1 = (start1_index === undefined) ? rawTimestamps.length - 2 : start1_index;
				const start2 = (start2_index === undefined) ? rawTimestamps.length - 1 : start2_index;

				noUiSlider.create(slider, {
					start: [start1, start2], 
					connect: true,
					step: 1, 
					range: {
						'min': 0,
						'max': rawTimestamps.length - 1
					},
					pips: { 
						mode: 'count',
						values: 5,
						density: 4
					}
				});

				slider.noUiSlider.on('update', function (values, handle) {
					const index1 = Math.round(values[0]);
					const index2 = Math.round(values[1]);
					
					const newTs1 = rawTimestamps[index1];
					const newTs2 = rawTimestamps[index2];
					
					input1.value = newTs1;
					input2.value = newTs2;
					
					display1.textContent = formattedTimestamps[newTs1] || newTs1;
					display2.textContent = formattedTimestamps[newTs2] || newTs2;
					
					const handles = slider.getElementsByClassName('noUi-handle');
					
					if (handles[0]) {
						if (index1 === min_index) {
							handles[0].classList.add('red-indicator');
						} else {
							handles[0].classList.remove('red-indicator');
						}
					}
				
					if (handles[1]) {
						if (index2 === max_index) {
							handles[1].classList.add('red-indicator');
						} else {
							handles[1].classList.remove('red-indicator');
						}
					}
				});
			} else {
				document.getElementById('timeSlider').innerHTML = '<p class="text-warning">비교 가능한 타임스탬프 데이터가 부족합니다.</p>';
			}
			
			
			document.getElementById('comparisonForm').addEventListener('submit', function(e) {
				if (input1.value === input2.value) {
					e.preventDefault();
					alert('비교를 위해 서로 다른 시간대를 선택해주세요.');
					return false;
				}
			});
		});
    </script>
	<script>
		$.fn.dataTable.ext.type.order['special-num-pre'] = function ( data ) {
			let num = data.replace(/[↑↓,-]/g, ''); 
			
			if (num === '') {
				return 0;
			}
			
			return parseFloat(num);
		};


		$(document).ready(function() {
			
			const table = $('#leaderboardTable').DataTable({
				"paging": false,
				"info": false,
				"ordering": true,
				"searching": false,
				"language": {
					"emptyTable": "비교할 데이터가 없습니다.",
					"zeroRecords": "일치하는 데이터가 없습니다."
				},
				"order": [[2, 'asc']], 
				"columnDefs": [
					{ "orderable": false, "targets": 0 },
					{ "orderable": true, "targets": "_all" }
				]
			});
			
			$('.dataTables_wrapper').addClass('no-footer');


			let currentSortColumn = 2; 
			let currentSortDirection = 'desc'; 

			const initialIndicator = (currentSortDirection === 'desc') ? ' ▲' : ' ▼';
            const defaultSortOption = $('.sort-option[data-column="' + currentSortColumn + '"]');
            if (defaultSortOption.length) {
                defaultSortOption.text(defaultSortOption.text() + initialIndicator);
            }
			$('#fabSortDropdown i').removeClass().addClass('fas fa-sort-amount-down-alt'); // 'desc' 방향 아이콘


			$('.sort-option').on('click', function(e) {
				e.preventDefault();
				
				const requestedColumn = parseInt($(this).data('column'));
				const defaultDirection = $(this).data('default-dir') || 'desc'; 
				let newDirection;

				if (requestedColumn === currentSortColumn) {
					newDirection = (currentSortDirection === 'asc') ? 'desc' : 'asc';
				} else {
					newDirection = defaultDirection;
				}

                $('.sort-option').each(function() {
                    let text = $(this).text().replace(' ▲', '').replace(' ▼', '');
                    $(this).text(text);
                });

				table.order([requestedColumn, newDirection]).draw();

				currentSortColumn = requestedColumn;
				currentSortDirection = newDirection;

                const indicator = (newDirection === 'asc') ? ' ▲' : ' ▼';
                const currentText = $(this).text();
                $(this).text(currentText + indicator);

				const iconClass = (newDirection === 'asc') ? 'fa-sort-amount-up-alt' : 'fa-sort-amount-down-alt';
				$('#fabSortDropdown i').removeClass().addClass('fas ' + iconClass);
			});
			
		const $usernameInput = $('#usernameInput');
		const $searchResults = $('#searchResults');
		const searchModal = new bootstrap.Modal(document.getElementById('searchModal'));
		
		function searchUsers(query) {
			$searchResults.empty();
			if (query.length < 2) { 
				$searchResults.append('<div class="list-group-item">최소 2글자 이상 입력해주세요.</div>');
				return;
			}

			const lowerQuery = query.toLowerCase();
			const foundUsers = [];
			
			table.rows().every(function() { 
				const rowData = this.data();
				const usernameCellHtml = rowData[0];
				const username = $(usernameCellHtml).text().trim(); 
				
				if (username.toLowerCase().includes(lowerQuery)) {
					foundUsers.push({
						username: username,
						data: rowData
					});
				}
			});


			if (foundUsers.length === 0) {
				$searchResults.append('<div class="list-group-item list-group-item-warning">일치하는 사용자가 없습니다.</div>');
				return;
			}

			foundUsers.forEach(function(user) {
				const $item = $(
					'<a href="#" class="list-group-item list-group-item-action" ' +
					'data-username="' + user.username + '">' + 
					user.username + '</a>'
				);
				$searchResults.append($item);
			});
		}

		let searchTimer;
		$usernameInput.on('keyup', function() {
			clearTimeout(searchTimer);
			const query = $usernameInput.val().trim();
			searchTimer = setTimeout(function() {
				searchUsers(query);
			}, 300);
		});

		$searchResults.on('click', 'a.list-group-item-action', function(e) {
			e.preventDefault();
			
			const usernameToFind = $(this).data('username');
			let $targetRow = null;

			table.rows().every(function() {
				const rowData = this.data();
				const cellText = $(rowData[0]).text().trim(); 
				if (cellText === usernameToFind) {
					$targetRow = $(this.node()); 
					return false; 
				}
			});

			if ($targetRow && $targetRow.length) {
				table.search('').draw();
				
				$('html, body').animate({
					scrollTop: $targetRow.offset().top - 100 
				}, 500);

				$targetRow.css('background-color', '#ffffe0'); 
				setTimeout(function() {
					$targetRow.css('background-color', ''); 
				}, 2000);
				
				searchModal.hide();
			} else {
				alert('테이블에서 사용자를 찾을 수 없습니다.');
			}
		});

		document.getElementById('searchModal').addEventListener('shown.bs.modal', function () {
			$('#usernameInput').focus();
		});
			
		});
	</script>

<div class="fixed-bottom d-flex flex-column align-items-end p-4" style="z-index: 80; left:auto;">
    <div class="dropdown dropup mb-3">
        <button class="btn btn-primary btn-lg rounded-circle shadow-lg fab-custom-size" 
                type="button" 
                id="fabSortDropdown" 
                data-bs-toggle="dropdown" 
                aria-expanded="false"
                style="width: 60px; height: 60px;">
            <i class="fas fa-sort-amount-down-alt"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="fabSortDropdown">
            <li class="dropdown-header">정렬 기준 선택</li>
            <li><a class="dropdown-item sort-option" href="#" data-column="1" data-default-dir="desc">이전 순위</a></li>
            <li><a class="dropdown-item sort-option" href="#" data-column="2" data-default-dir="desc">현재 순위</a></li>
            <li><a class="dropdown-item sort-option" href="#" data-column="3" data-default-dir="desc">순위 변화</a></li>
            <li><a class="dropdown-item sort-option" href="#" data-column="4" data-default-dir="desc">이전 {{ metric_display_name }}</a></li>
            <li><a class="dropdown-item sort-option" href="#" data-column="5" data-default-dir="desc">현재 {{ metric_display_name }}</a></li>
            <li><a class="dropdown-item sort-option" href="#" data-column="6" data-default-dir="desc">{{ metric_display_name }} 변화</a></li>
        </ul>
    </div>
    
    <div class="d-flex align-items-center">
		<button class="btn btn-secondary btn-lg rounded-circle shadow-lg me-3 fab-custom-size" 
				type="button" 
				id="fabScrollTop" 
				style="background-color: #6c757d !important; border-color: #6c757d !important; display: none;"> 
			<i class="fas fa-arrow-up"></i>
		</button>
        
        <button class="btn btn-info btn-lg rounded-circle shadow-lg fab-custom-size" 
                type="button" 
                data-bs-toggle="modal" 
                data-bs-target="#searchModal"
                style="width: 60px; height: 60px;">
            <i class="fas fa-search"></i>
        </button> 
    </div>
</div>

<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">사용자 검색 및 이동</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="usernameInput" class="form-label">검색할 사용자 이름:</label>
          <input type="text" class="form-control" id="usernameInput" placeholder="사용자 이름을 입력하세요">
        </div>
        <div id="searchResults" class="list-group">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
<script>
	const scrollTopButton = document.getElementById('fabScrollTop');
	const scrollThreshold = 300; 


	window.addEventListener('scroll', function() {
		if (window.scrollY > scrollThreshold) {
			scrollTopButton.style.display = 'flex';
		} else {
			scrollTopButton.style.display = 'none';
		}
	});

	scrollTopButton.addEventListener('click', function(e) {
		e.preventDefault();
		$('html, body').animate({
			scrollTop: 0
		}, 500); 
	});
</script>
</body>
</html>
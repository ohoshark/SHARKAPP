<!DOCTYPE html>
<%
    i18n = {
        'ko': {
			'pre': 'ì´ì „',
			'cur': 'í˜„ì¬',
			'change': 'ë³€í™”',
			'ms': 'ë§ˆì‰',
            'title_suffix': 'ë¦¬ë”ë³´ë“œ ë³€í™” ë¶„ì„',
            'user_analysis': 'ì‚¬ìš©ì ë¶„ì„',
            'leaderboard_analysis': 'ë¦¬ë”ë³´ë“œ ë¶„ì„',
            'data_standard': 'ë°ì´í„° ê¸°ì¤€',
            'compare_btn': 'ë¹„êµí•˜ê¸°',
            'prev_point': 'ì´ì „ ì‹œì ',
            'curr_point': 'í˜„ì¬ ì‹œì ',
			'Analysis_Result': 'ë¶„ì„ ê²°ê³¼',
            'user': 'ì‚¬ìš©ì',
			'pre_rank': 'ì´ì „ ìˆœìœ„',
			'curr_rank': 'í˜„ì¬ ìˆœìœ„',
            'rank_change': 'ìˆœìœ„ ë³€í™”',
			'pre_ms': 'ì´ì „ ë§ˆì‰',
			'curr_ms': 'í˜„ì¬ ë§ˆì‰',
			'ms_change': 'ë§ˆì‰ ë³€í™”',
			'result': 'ë¶„ì„ ê²°ê³¼',
            'search_placeholder': 'ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”',
            'close': 'ë‹«ê¸°',
            'copy_success': 'ì§€ê°‘ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¦ˆ',
            'click_to_copy': 'í´ë¦­í•˜ì—¬ ì£¼ì†Œ ë³µì‚¬ ğŸ¦ˆ'
        },
        'en': {
			'pre': 'Pre',
			'cur': 'Cur',
			'change': 'Change',
			'ms': 'MS',
            'title_suffix': 'Leaderboard Analysis',
            'user_analysis': 'User Analysis',
            'leaderboard_analysis': 'Leaderboard',
            'data_standard': 'Time',
            'compare_btn': 'COMPARE',
            'prev_point': 'Prev Point',
            'curr_point': 'Curr Point',
			'Analysis_Result': 'Analysis Result',
            'user': 'User',
			'pre_rank': 'Pre Rank',
			'curr_rank': 'Cur Rank',
            'rank_change': 'Rank Change',
			'pre_ms': 'Pre MS',
			'curr_ms': 'Cur MS',
			'ms_change': 'MS Change',
			'result': 'Analysis Result',
            'search_placeholder': 'Enter username...',
            'close': 'Close',
            'copy_success': 'Wallet address copied! ğŸ¦ˆ',
            'click_to_copy': 'Click to copy addressğŸ¦ˆ'
        }
    }
    t = i18n.get(lang, i18n['ko'])
%>
<html lang="{{lang}}">
% include('_head.html')
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="/static/css/leaderboard.css">
<title>{{display_project_name}} {{t['title_suffix']}} - SHARKAPP</title>
<style>
		/* DataTables í˜ì´ì§• ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ í†µì¼ */
		.dataTables_wrapper .dataTables_length select {
			padding: 0.375rem 2.25rem 0.375rem 0.75rem;
			border: 1px solid #dee2e6;
			border-radius: 0.25rem;
			background-color: #fff;
			font-size: 1rem;
			line-height: 1.5;
			margin-top: 3px;
		}
		
		.dataTables_wrapper .dataTables_length,
		.dataTables_wrapper .dataTables_paginate {
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0.5rem 0;
		}
		
		.dataTables_wrapper .dataTables_length {
			justify-content: flex-start;
		}
		
		.dataTables_wrapper .dataTables_paginate {
			justify-content: flex-end;
		}
		
		@media (max-width: 767.98px) {
			.table-responsive td:nth-of-type(1):before { content: "{{t['user']}}"; }
			.table-responsive td:nth-of-type(2):before { content: "{{t['prev_point']}}"; }
			.table-responsive td:nth-of-type(3):before { content: "{{t['curr_point']}}"; }
			.table-responsive td:nth-of-type(4):before { content: "{{t['rank_change']}}"; }
			.table-responsive td:nth-of-type(5):before { content: "{{t['pre']}} {{t['ms']}}"; }
			.table-responsive td:nth-of-type(6):before { content: "{{t['cur']}} {{t['ms']}}"; } 
			.table-responsive td:nth-of-type(7):before { content: "{{t['ms']}} {{t['change']}}"; } 
			
			/* ëª¨ë°”ì¼ì—ì„œ í˜ì´ì§• ì»¨íŠ¸ë¡¤ ê°„ê²© ì¡°ì • */
			.dataTables_wrapper .dataTables_length,
			.dataTables_wrapper .dataTables_paginate {
				padding: 0.5rem 0.25rem;
			}
		}
		
		/* ë‹¤í¬ëª¨ë“œì—ì„œ ìƒìŠ¹ ìƒ‰ìƒ ìœ ì§€ - DataTables ì´ˆê¸°í™” í›„ì—ë„ ì ìš© */
		.dark-mode .text-success,
		.dark-mode table .text-success,
		.dark-mode .dataTables_wrapper .text-success,
		.dark-mode #leaderboardTable .text-success {
			color: #28a745 !important;
		}
		.dark-mode .text-danger,
		.dark-mode table .text-danger,
		.dark-mode .dataTables_wrapper .text-danger,
		.dark-mode #leaderboardTable .text-danger {
			color: #dc3545 !important;
		}
	</style>
</head>

<body>
% include('_navbar.html')

    <div class="container mt-4">
        <div class="card timestamp-selector">
            <div class="card-header">
                <h5><b>{{display_project_name.upper()}}</b> {{t['title_suffix']}}</h5>
            </div>
			<div class="card-body">
				<form id="comparisonForm" method="get" action="/kaito/{{project}}/leaderboard">
					<div class="row g-3 align-items-end">
						<div class="col-md-3">
							<label class="form-label">{{t['data_standard']}}</label>
							<select name="timeframe" id="timeframe" class="form-select" onchange="this.form.submit()">
								% for tf in timeframes:
									<option value="{{tf}}" {{'selected' if tf == timeframe else ''}}>{{tf.upper()}}</option>
								% end
							</select>
						</div>
						<div class="col-12">
							<div class="d-flex justify-content-between mb-3">
								<div class="text-start">
									<strong>{{t['prev_point']}}</strong> 
									<span id="slider-timestamp1" class="text-muted">{{timestamp1_display}}</span>
								</div>
								<div class="text-end">
									<strong>{{t['curr_point']}}</strong> 
									<span id="slider-timestamp2" class="text-muted">{{timestamp2_display}}</span>
								</div>
							</div>
							
							<div id="timeSlider" style="margin: 0 10px;"></div>
							
							<input type="hidden" name="timestamp1" id="timestamp1" value="{{timestamp1}}">
							<input type="hidden" name="timestamp2" id="timestamp2" value="{{timestamp2}}">
						</div>
						<div class="d-flex justify-content-end mt-5">
						<button type="submit" class="btn btn-primary px-4">{{t['compare_btn']}}</button>
					</div>
				</div>
			</form>
			</div>
		</div>
        
        <div class="card comparison-table">
            <div class="card-header">
                <h3>
                    {{t['result']}} 
                    <small class="text-muted">
                        ({{ timestamp1_display }} â†’ {{ timestamp2_display }})
                    </small>
                </h3>
            </div>
			<div class="card-body">
				<div class="table-responsive">
					{{ !table_html }}
				</div>
			</div>
        </div>
    </div>

    <script>
		// Compressed data - minified for performance
		const rawTimestamps = {{ !timestamps }};
		const formattedTimestamps = {{ !formatted_timestamps }};

		const currentTs1 = "{{ timestamp1 }}";
		const currentTs2 = "{{ timestamp2 }}";

		const timestampMap = {};
		rawTimestamps.forEach((ts, index) => {
			timestampMap[ts] = index;
		});

		document.addEventListener('DOMContentLoaded', function() {
			const slider = document.getElementById('timeSlider');
			const input1 = document.getElementById('timestamp1');
			const input2 = document.getElementById('timestamp2');
			const display1 = document.getElementById('slider-timestamp1');
			const display2 = document.getElementById('slider-timestamp2');

			if (rawTimestamps.length >= 2) {
				const min_index = 0;
				const max_index = rawTimestamps.length - 1;
				let start1_index = timestampMap[currentTs1];
				let start2_index = timestampMap[currentTs2];

				const start1 = (start1_index === undefined) ? rawTimestamps.length - 2 : start1_index;
				const start2 = (start2_index === undefined) ? rawTimestamps.length - 1 : start2_index;

				noUiSlider.create(slider, {
					start: [start1, start2], 
					connect: true,
					step: 1, 
					range: {
						'min': 0,
						'max': rawTimestamps.length - 1
					},
					pips: { 
						mode: 'count',
						values: 5,
						density: 4
					}
				});

				slider.noUiSlider.on('update', function (values, handle) {
					const index1 = Math.round(values[0]);
					const index2 = Math.round(values[1]);
					
					const newTs1 = rawTimestamps[index1];
					const newTs2 = rawTimestamps[index2];
					
					input1.value = newTs1;
					input2.value = newTs2;
					
					display1.textContent = formattedTimestamps[newTs1] || newTs1;
					display2.textContent = formattedTimestamps[newTs2] || newTs2;
					
					const handles = slider.getElementsByClassName('noUi-handle');
					
					if (handles[0]) {
						if (index1 === min_index) {
							handles[0].classList.add('red-indicator');
						} else {
							handles[0].classList.remove('red-indicator');
						}
					}
				
					if (handles[1]) {
						if (index2 === max_index) {
							handles[1].classList.add('red-indicator');
						} else {
							handles[1].classList.remove('red-indicator');
						}
					}
				});
			} else {
				document.getElementById('timeSlider').innerHTML = '<p class="text-warning">ë¹„êµ ê°€ëŠ¥í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>';
			}
			
			document.getElementById('comparisonForm').addEventListener('submit', function(e) {
				if (input1.value === input2.value) {
					e.preventDefault();
					alert('ë¹„êµë¥¼ ìœ„í•´ ì„œë¡œ ë‹¤ë¥¸ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
					return false;
				}
			});
		});
    </script>
	<script>
		// HTMLì—ì„œ data-order ì†ì„± ì¶”ì¶œ ë˜ëŠ” í…ìŠ¤íŠ¸ì—ì„œ ìˆ«ì ì¶”ì¶œ
		$.fn.dataTable.ext.type.order['special-num-pre'] = function ( data ) {
			// data-order ì†ì„±ì´ ìˆìœ¼ë©´ ê·¸ ê°’ ì‚¬ìš©
			const match = data.match(/data-order="([^"]+)"/);
			if (match) {
				return parseFloat(match[1]);
			}
			
			// NEW, OUT ë°°ì§€ ì²˜ë¦¬ (0ìœ¼ë¡œ ì²˜ë¦¬)
			if (data.includes('NEW')) {
				return 0;
			}
			if (data.includes('OUT')) {
				return 0;
			}
			
			// í™”ì‚´í‘œì™€ íŠ¹ìˆ˜ë¬¸ì ì œê±° í›„ ìˆ«ì ì¶”ì¶œ
			let num = data.replace(/<[^>]*>/g, '').replace(/[â†‘â†“,+%\s-]/g, '');
			if (num === '' || isNaN(num)) {
				return 9999;
			}
			return parseFloat(num);
		};

		$(document).ready(function() {
			const $tableElement = $('#leaderboardTable');
			let table = null;
			
			if ($tableElement.length > 0) {
				table = $tableElement.DataTable({
					"dom": "<'row'<'col-6 col-md-6'l><'col-6 col-md-6'p>>" +
						   "<'row'<'col-sm-12'tr>>" +
						   "<'row'<'col-sm-12 text-center'i>>",
					"paging": true,
					"pageLength": 300,
					"lengthMenu": [[100, 300, 500, -1], [100, 300, 500, "All"]],
					"searching": true,
					"ordering": true,
					"info": true,
					"autoWidth": false,
					"responsive": false,
					"order": [[2, 'asc']],
					"columnDefs": [
						{ "orderable": false, "targets": [0] },
						{ "type": "special-num", "targets": [1,2,3,4,5,6] }
					],
					"language": {
						"lengthMenu": "_MENU_",
						"search": "",
						"searchPlaceholder": "{{t['search_placeholder']}}",
						"info": "_START_-_END_ / _TOTAL_",
						"infoEmpty": "0 / 0",
						"infoFiltered": "",
						"paginate": {
							"first": "First",
							"last": "Last",
							"next": "â€º",
							"previous": "â€¹"
						}
					}
				});
			}
		});
	</script>
% include('_footer.html')
</body>
</html>
